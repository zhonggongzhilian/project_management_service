{% extends 'layouts/base.html' %}

{% block title %} 科技项目部 {% endblock title %}

{% block content %}

<style>
  /* Ensure the table layout is auto */
  .table {
    table-layout: auto;
  }

  /* Allow text to wrap and add some padding for better readability */
  .table td {
    word-wrap: break-word;
    white-space: normal; /* Ensure text wraps and doesn't overflow */
  }

  /* Optionally, you can also set a max-width if you want to limit the column width */
  .table td:nth-child(2) { /* Assuming the 2nd column is 项目进展 */
    max-width: 200px; /* Adjust this value as needed */
    min-width: 200px;
  }
</style>

<!-- Header -->
<div class="header bg-primary pb-6">
    <div class="container-fluid">
        <div class="header-body">

            <div class="row align-items-center py-4">
                <div class="col-lg-6 col-7">
                    <h6 class="h2 text-white d-inline-block mb-0">科技项目部项目进度管理</h6>
                </div>
                <div class="col-lg-6 col-5 text-right">
                    <button type="button" class="btn btn-sm btn-neutral" data-toggle="modal"
                            data-target="#newProjectModal">新建项目
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Page content -->
<div class="container-fluid mt--6">
    <div class="row">
        <div class="col">
            <div class="card border-0">
                <div class="card-header">
                    <h3 class="mb-0">项目列表</h3>
                </div>
                <div class="table-responsive">
                    <table class="table align-items-center table-flush">
                        <thead class="thead-light">
                        <tr>
                            <th scope="col">项目类型</th>
                            <th scope="col">项目名称</th>
                            <th scope="col">项目进展</th>
                            <th scope="col">历史进展</th>
                            <th scope="col">开始日期</th>
                            <th scope="col">结束日期</th>
                            <th scope="col">状态</th>
                            <th scope="col">进度</th>
                            <th scope="col">负责人</th>
                            <th scope="col">客户名称</th> <!-- 新增客户名称列 -->
                            <th scope="col">进度预警</th>
                            <th scope="col">操作</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for project in projects %}
                        <tr class="project-row" data-id="{{ project.id }}"
                            data-name="{{ project.name }}"
                            data-start-date="{{ project.start_date }}"
                            data-end-date="{{ project.end_date }}"
                            data-status="{{ project.status }}"
                            data-progress="{{ project.progress }}">
                            <td>{{ project.project_type.name }}</td>
                            <td>{{ project.name }}</td>
                            <td>{{ project.description|linebreaksbr }}</td>
                            <td>
                                <button type="button" class="btn btn-info btn-sm" data-toggle="modal"
                                        data-target="#historyModal" data-project-id="{{ project.id }}">
                                    查看历史进度
                                </button>
                            </td>
                            <td>{{ project.start_date|date:"Y年n月j日" }}</td>
                            <td>{{ project.end_date|date:"Y年n月j日" }}</td>
                            <td>{{ project.get_status_display }}</td>
                            <td>{{ project.progress }}%</td>
                            <td>{{ project.owner }}</td>
                            <td>
                                {% if project.client %}
                                    {{ project.client.name }}
                                {% else %}
                                    无
                                {% endif %}
                            </td>
                            <td>
                                {% if project.end_date < today %}
                                ⚠️已逾期
                                {% else %}
                                进度正常
                                {% endif %}
                            </td>
                            <td>
                                <button type="button" class="btn btn-info btn-sm" data-toggle="modal"
                                        data-target="#editProjectModal" data-project-id="{{ project.id }}">
                                    修改项目信息
                                </button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="12" class="text-center">没有项目</td>
                        </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    {% include "includes/footer.html" %}

</div>

<!-- History Modal -->
<div class="modal fade" id="historyModal" tabindex="-1" role="dialog" aria-labelledby="historyModalLabel"
     aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="historyModalLabel">项目历史进度</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <table class="table align-items-center table-flush">
                    <thead class="thead-light">
                    <tr>
                        <th scope="col">日期</th>
                        <th scope="col">描述</th>
                    </tr>
                    </thead>
                    <tbody id="historyTableBody">
                    <!-- Historical data will be injected here via JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- New Project Modal -->
<div class="modal fade" id="newProjectModal" tabindex="-1" role="dialog" aria-labelledby="newProjectModalLabel"
     aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newProjectModalLabel">新建项目</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form method="post" action="{% url 'dep_tech_create_project' %}">
                    {% csrf_token %}
                    <div class="form-group">
                        <label for="projectName">项目名称</label>
                        <input type="text" class="form-control" id="projectName" name="name" required>
                    </div>
                    <div class="form-group">
                        <label for="projectType">项目类型</label>
                        <select class="form-control" id="projectType" name="project_type" required>
                            {% for project_type in project_types %}
                            <option value="{{ project_type.id }}">{{ project_type.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="startDate">开始日期</label>
                        <input type="date" class="form-control" id="startDate" name="start_date" required>
                    </div>
                    <div class="form-group">
                        <label for="endDate">结束日期</label>
                        <input type="date" class="form-control" id="endDate" name="end_date" required>
                    </div>
                    <div class="form-group">
                        <label for="client">客户名称</label>
                        <input type="text" class="form-control" id="clientSearch" placeholder="搜索客户..." onkeyup="filterClients()">
                        <select class="form-control" id="clientSelect" name="client">
                            <option value="">选择客户</option>
                            {% for customer in customers %}
                            <option value="{{ customer.id }}">{{ customer.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="status">状态</label>
                        <select class="form-control" id="status" name="status" required>
                            <option value="not_started">未开始</option>
                            <option value="in_progress">进行中</option>
                            <option value="completed">已完成</option>
                            <option value="delayed">延期</option>
                            <option value="stopped">停滞</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">保存</button>
                </form>
            </div>
        </div>
    </div>
</div>



<!-- Edit Project Modal -->
<div class="modal fade" id="editProjectModal" tabindex="-1" role="dialog" aria-labelledby="editProjectModalLabel"
     aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editProjectModalLabel">编辑项目</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form method="post" action="{% url 'dep_tech_edit_project' %}">
                    {% csrf_token %}
                    <input type="hidden" id="editProjectId" name="id">
                    <div class="form-group">
                        <label for="editProjectName">项目名称</label>
                        <input type="text" class="form-control" id="editProjectName" name="name" required>
                    </div>
                    <div class="form-group">
                        <label for="editClient">客户名称</label>
                        <input type="text" class="form-control" id="editClientSearch" placeholder="搜索客户..." onkeyup="filterEditClients()">
                        <select class="form-control" id="editClientSelect" name="client">
                            <option value="">选择客户</option>
                            {% for customer in customers %}
                            <option value="{{ customer.id }}">{{ customer.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editStatus">状态</label>
                        <select class="form-control" id="editStatus" name="status" required>
                            <option value="not_started">未开始</option>
                            <option value="in_progress">进行中</option>
                            <option value="completed">已完成</option>
                            <option value="delayed">延期</option>
                            <option value="stopped">停滞</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editProgress">进度 (%)</label>
                        <input type="number" class="form-control" id="editProgress" name="progress" required>
                    </div>
                    <button type="submit" class="btn btn-primary">保存修改</button>
                </form>
            </div>
        </div>
    </div>
</div>


{% endblock content %}

{% block javascripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        $('#editProjectModal').on('show.bs.modal', function (event) {
            var button = $(event.relatedTarget); // Button that triggered the modal
            var row = button.closest('tr'); // Get the row containing the button

            // Extract data from the row
            var projectId = row.data('id');
            var projectName = row.data('name');
            var startDate = row.data('start-date');
            var endDate = row.data('end-date');
            var status = row.data('status');
            var progress = row.data('progress');

            // Populate the modal form with the project data
            $('#editProjectId').val(projectId);
            $('#editProjectName').val(projectName);
            $('#editStartDate').val(startDate);
            $('#editEndDate').val(endDate);
            $('#editStatus').val(status);
            $('#editProgress').val(progress);
        });
    });
</script>

<script>
    $(document).ready(function() {
      $('.project-row').on('click', function() {
        var projectId = $(this).data('id');
        var projectName = $(this).data('name');
        var projectDescription = $(this).data('description');
        var startDate = $(this).data('start_date');
        var endDate = $(this).data('end_date');
        var status = $(this).data('status');
        var priority = $(this).data('priority');
        var project_type = $(this).data('project_type');

        $('#editProjectId').val(projectId);
        $('#editProjectName').val(projectName);
        $('#editProjectDescription').val(projectDescription);
        $('#editStartDate').val(startDate);
        $('#editEndDate').val(endDate);
        $('#editStatus').val(status);
        $('#editPriority').val(priority);
        $('#editProjectType').val(project_type);
      });
    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        $('#historyModal').on('show.bs.modal', function (event) {
            var button = $(event.relatedTarget); // Button that triggered the modal
            var projectId = button.data('project-id'); // Extract info from data-* attributes

            var modal = $(this);

            // Fetch historical data for the selected project
            $.ajax({
                url: '{% url "get_daily_items" %}', // Adjust URL as needed
                data: {
                    project_id: projectId
                },
                success: function (data) {
                    var tableBody = modal.find('#historyTableBody');
                    tableBody.empty(); // Clear existing data

                    data.forEach(function (item) {
                        tableBody.append(`
                            <tr>
                                <td>${item.date}</td>
                                <td>${item.description}</td>
                            </tr>
                        `);
                    });
                }
            });
        });
    });
</script>

<script>
    function filterClients() {
        const searchValue = document.getElementById('clientSearch').value.toLowerCase();
        const clientSelect = document.getElementById('clientSelect');
        const options = clientSelect.options;

        for (let i = 1; i < options.length; i++) {
            const option = options[i];
            const text = option.text.toLowerCase();
            option.style.display = text.includes(searchValue) ? '' : 'none';
        }
    }
</script>
<script>
    function filterEditClients() {
        const searchValue = document.getElementById('editClientSearch').value.toLowerCase();
        const clientSelect = document.getElementById('editClientSelect');
        const options = clientSelect.options;

        for (let i = 1; i < options.length; i++) {
            const option = options[i];
            const text = option.text.toLowerCase();
            option.style.display = text.includes(searchValue) ? '' : 'none';
        }
    }
</script>

{% endblock javascripts %}